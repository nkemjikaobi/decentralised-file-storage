import type { NextPage } from 'next';
import Head from 'next/head';
import { useRef, useState } from 'react';
import FileList from '../components/FileList';
import ShareModal from '../components/modals/ShareModal';
import UploadFileModal from '../components/modals/UploadFileModal';
import toast, { Toaster } from 'react-hot-toast';
import WalletContext from 'context/wallet/WalletContext';
import { useContext, useEffect } from 'react';
import { useRouter } from 'next/router';

const Dashboard: NextPage = () => {
	const [filesToWorkWith, setFilesToWorkWith] = useState<any>();

	const [uploadFileModal, setUploadFileModal] = useState<boolean>(false);
	const [shareModal, setShareModal] = useState<boolean>(false);
	const [counter, setCounter] = useState<number>(0);
	const [allFiles, setAllFiles] = useState<any>([]);
	const [myLibrary, setMyLibrary] = useState<any>([]);
	const [shared, setShared] = useState<any>([]);
	const [isAllFiles, setIsAllFiles] = useState<boolean>(true);
	const [isMyLibrary, setIsMyLibrary] = useState<boolean>(false);
	const [activeId, setActiveId] = useState<number>();
	const walletContext = useContext(WalletContext);

	const {
		disconnectWallet,
		web3Modal,
		message,
		error,
		clearMessage,
		clearError,
		address,
		connectWallet,
		fetchFiles,
		contract,
		files,
		sharedFiles,
		searchedFiles,
		clearSearch,
		search,
	} = walletContext;
	const router = useRouter();

	const reconnectWallet = async () => {
		await connectWallet(router);
	};

	//Reconnect wallet on page refresh
	useEffect(() => {
		let mounted = true;

		if (mounted && localStorage?.getItem('isWalletConnected') === 'true') {
			reconnectWallet();
		}
		return () => {
			mounted = false;
		};
		//eslint-disable-next-line
	}, []);

	//Fetch files
	useEffect(() => {
		let mounted = true;
		if (mounted && address !== null && contract !== null && counter === 0) {
			fetchFiles(contract);
			setCounter(3);
		}
		return () => {
			mounted = false;
		};
		//eslint-disable-next-line
	}, [address, contract]);

	//Handle Messages
	useEffect(() => {
		let mounted = true;

		if (mounted && message !== null) {
			toast.success(message);
			setTimeout(() => clearMessage(), 3000);
		}
		return () => {
			mounted = false;
		};
		//eslint-disable-next-line
	}, [message]);

	//Handle Errors
	useEffect(() => {
		let mounted = true;

		if (mounted && error !== null) {
			toast.error(error);
			setTimeout(() => clearError(), 3000);
		}
		return () => {
			mounted = false;
		};
		//eslint-disable-next-line
	}, [error]);

	//Filtered files
	useEffect(() => {
		let mounted = true;

		if (mounted && filesToWorkWith !== undefined) {
			const filteredFiles =
				filesToWorkWith &&
				filesToWorkWith.filter((file: any) => file.isPrivate === false);
			setAllFiles(filteredFiles);
		}
		return () => {
			mounted = false;
		};
		//eslint-disable-next-line
	}, [filesToWorkWith]);

	//Files to work with
	useEffect(() => {
		let mounted = true;

		if (mounted && searchedFiles.length > 0) {
			setFilesToWorkWith(searchedFiles);
		} else {
			setFilesToWorkWith(files);
		}
		return () => {
			mounted = false;
		};
		//eslint-disable-next-line
	}, [searchedFiles, files]);

	const handleAllFiles = () => {
		setIsAllFiles(true);
		setIsMyLibrary(false);
		const filteredFiles =
			filesToWorkWith &&
			filesToWorkWith.filter((file: any) => file.isPrivate === false);
		setAllFiles(filteredFiles);
	};

	const handleMyLibrary = () => {
		setIsAllFiles(false);
		setIsMyLibrary(true);
		const filteredFiles =
			filesToWorkWith &&
			filesToWorkWith.filter(
				(file: any) => file.isPrivate === true && file.uploadedBy === address
			);
		setMyLibrary(filteredFiles);
		const shared =
			filesToWorkWith &&
			filesToWorkWith.filter((file: any) => file.sharedWith.includes(address));
		setShared(shared);
	};

	const [text, setText] = useState<string>('');

	useEffect(() => {
		if (searchedFiles.length === 0) {
			text === '';
		}

		//eslint-disable-next-line
	}, [searchedFiles]);

	const onChange = (e: any) => {
		if (e.target.value !== '') {
			console.log(e.target.value);

			setText(e.target.value);
			search(e.target.value);
		} else {
			clearSearch();
			setText('');
		}
	};

	return (
		<div>
			<Head>
				<title>Dashboard</title>
				<meta name='description' content='Generated by create next app' />
				<link rel='icon' href='/favicon.ico' />
			</Head>
			<Toaster position='top-right' />

			<main className='container mt-4 '>
				<div
					className={`${uploadFileModal && 'blur-lg'} ${
						shareModal && 'blur-lg'
					}`}
				>
					<nav className='flex justify-between items-center'>
						<h2
							className='text-4xl font-bold text-center cursor-pointer'
							onClick={() => router.push('/')}
						>
							Dinata
						</h2>
						<input
							type='text'
							placeholder='Search for any file'
							className='rounded-lg px-5 py-4 w-96 text-black'
							value={text}
							onChange={onChange}
						/>
						<button
							className='flex justify-center items-center mt-10 bg-sky-500 w-48 px-5 py-3 text-base rounded-lg hover:bg-sky-900'
							onClick={() => disconnectWallet(web3Modal, router)}
						>
							Logout
						</button>
					</nav>
					<section className='mt-8'>
						<h4 className='text-base mb-4'>
							Welcome user,{' '}
							<span className='text-2xl text-purple-600'>{address}</span>
						</h4>
						<hr />
						<div className='mt-16 flex justify-center items-center'>
							<button
								className={`flex mr-4 justify-center items-center mt-10 ${
									isAllFiles ? 'bg-sky-500' : 'border-sky-500 border'
								}  w-48 px-5 py-3 text-base rounded-lg`}
								onClick={() => handleAllFiles()}
							>
								All Files
							</button>
							<button
								className={`flex justify-center items-center mt-10 ${
									isMyLibrary ? ' bg-sky-500' : ' border-sky-500 border'
								} w-48 px-5 py-3 mr-5 text-base rounded-lg`}
								onClick={() => handleMyLibrary()}
							>
								My Library
							</button>
						</div>
						{isAllFiles && (
							<FileList
								title='All Files'
								data={allFiles}
								setUploadFileModal={setUploadFileModal}
								setShareModal={setShareModal}
								isAllFiles={isAllFiles}
							/>
						)}
						{!isAllFiles && (
							<FileList
								title='My Files'
								setUploadFileModal={setUploadFileModal}
								setShareModal={setShareModal}
								isAllFiles={isAllFiles}
								data={myLibrary}
								setActiveId={setActiveId}
							/>
						)}
						{!isAllFiles && (
							<FileList
								title='Shared with me'
								setUploadFileModal={setUploadFileModal}
								setShareModal={setShareModal}
								isAllFiles={isAllFiles}
								data={shared}
								hasUpload={false}
							/>
						)}
					</section>
				</div>
				{uploadFileModal && (
					<div className='absolute top-1/4 left-1/4 ml-64'>
						<UploadFileModal setUploadFileModal={setUploadFileModal} />
					</div>
				)}
				{shareModal && (
					<div className='absolute top-1/4 left-1/4 ml-64'>
						<ShareModal activeId={activeId} setShareModal={setShareModal} />
					</div>
				)}
			</main>
		</div>
	);
};

export default Dashboard;
